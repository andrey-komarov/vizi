package ru.ifmo.vizi.FarachColtonBender;

import ru.ifmo.vizi.base.Base;
import ru.ifmo.vizi.base.VisualizerParameters;
import ru.ifmo.vizi.base.ui.*;
import ru.ifmo.vizi.*;
import ru.ifmo.vizi.base.widgets.Rect;
import ru.ifmo.vizi.base.widgets.ShapeStyle;

import java.awt.*;
import java.awt.event.AdjustmentEvent;
import java.awt.event.AdjustmentListener;
import java.util.*;

static String treeAsSting(int[] a) {
	StringBuilder sb = new StringBuilder();
	sb.append("{");
	for (int i = 0; i < data.array.length; i++) {
		sb.append("(" + (i + 1) + ", " + data.array[i] + ")" + ((i == data.array.length - 1) ? "" : ", "));
	}
	sb.append("}");
	return sb.toString();
}


public final class FarachColtonBenderVisualizer extends Base implements
		AdjustmentListener {
	/**
	 * Find maximum automata instance.
	 */
	private final FarachColtonBender auto;

	/**
	 * Find maximum automata data.
	 */
	private final FarachColtonBender.Data data;

	private Rect[] array;
	
	private Rect[] tree;

	private final ShapeStyle[] matrixStyleSet, linearStyleSet;

	private final AdjustablePanel size;

	private final AdjustablePanel leftBorder;

	private final AdjustablePanel rightBorder;

	private int mainWidth, windowWidth, windowHeight;
	
	/**
	 * Creates a new Find Maximum visualizer.
	 * 
	 * @param parameters
	 *            visualizer parameters.
	 */
	public FarachColtonBenderVisualizer(VisualizerParameters parameters) {
		super(parameters);
		auto = new FarachColtonBender(locale);
		data = auto.d;
		data.visualizer = this;

		size = new AdjustablePanel(config, "array-size");
		size.addAdjustmentListener(this);

		leftBorder = new AdjustablePanel(config, "left-border");
		leftBorder.addAdjustmentListener(this);

		rightBorder = new AdjustablePanel(config, "right-border");
		rightBorder.addAdjustmentListener(this);

		matrixStyleSet = ShapeStyle.loadStyleSet(config, "matrix-styleSet");
		linearStyleSet = ShapeStyle.loadStyleSet(config, "linear-styleSet");

		randomize();
		
		clientPane.setSize(2000, 1200);
		createInterface(auto);
	}

	void clear() {
		layoutClientPane(windowWidth, windowHeight);
		if (array == null)
			return;
		for (int i = 0; i < data.array.length; i++) {
			if (array[i] != null)
				clientPane.remove(array[i]);
		}
	}

	public void adjustmentValueChanged(AdjustmentEvent t) {
		if (t.getSource() == size) {
			clear();
			auto.getController().doRestart();
			int n = t.getValue();
			data.array = new int[n];
			array = new Rect[n];
	        leftBorder.setMaximum(n);
	        leftBorder.setValue(1);
	        rightBorder.setMaximum(n);
	        rightBorder.setValue(n);
			randomize();
		}
	}

	public void randomize() {
		int n = data.array.length;
		Random rnd = new Random();
		for (int i = 0; i < n; i++) {
			data.array[i] = (int) (Math.random() * 99) + 1;
		}
		clear();
		array = new Rect[n];
		for (int i = 0; i < n; i++) {
			array[i] = new Rect(linearStyleSet);
			array[i].setMessage(String.valueOf(data.array[i]));
			array[i].setSize(mainWidth, mainWidth);
			array[i].adjustFontSize();
			array[i].setLocation(mainWidth * i, 0);
			clientPane.add(array[i]);
		}
		auto.getController().doRestart();
	}

	void layoutMainArray() {
		int n = data.array.length;
		mainWidth = windowWidth / n;
		int height = windowHeight / 10;
		mainWidth = Math.min(mainWidth, height);
		
		for (int i = 0; i < n; i++) {
			Rect now = array[i];
			if (now != null) {
				now.setSize(mainWidth, mainWidth);
				now.setBounds(i * mainWidth, 0, mainWidth, mainWidth);
				now.adjustFontSize();
			}
		}
	}
	
	/**
	 * Invoked when client pane shoud be layouted.
	 * 
	 * @param clientWidth
	 *            client pane width.
	 * @param clientHeight
	 *            client pane height.
	 */
	protected void layoutClientPane(int clientWidth, int clientHeight) {
		if (data.array == null || array == null)
			return;
		int n = data.array.length;

		windowHeight = clientHeight;
		windowWidth = clientWidth;

		layoutMainArray();
	}

	protected Component createControlsPane() {
		Container panel = new Panel(new BorderLayout());

		Panel bottomPanel = new Panel();
		bottomPanel.add(new HintedButton(config, "button-random") {
			protected void click() {
				randomize();
			}
		});
		bottomPanel.add(size);
		bottomPanel.add(leftBorder);
		bottomPanel.add(rightBorder);
		panel.add(bottomPanel, BorderLayout.CENTER);

		panel.add(new AutoControlsPane(config, auto, forefather, false),
				BorderLayout.SOUTH);

		return panel;

	}
	
}
