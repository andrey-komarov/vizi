<?xml
    version = "1.0"
    encoding = "WINDOWS-1251"
?>

<!--
    "MSort" algoritm description using auto-reverse feature.
-->

<algorithm>
    <variable 
        description = "Массив, подлежащий сортировке"
        name = "a"
        type = "int[]"
        value = "new int[]{15, 14, 65, 24, 98, 73, 21, 7}"
    />
    <variable description = "Массив для хранения левых границ сортируемых
                             массивов (необходим для рекурсии)"
        name = "l"
        type = "int[]"
        value = "new int[]{0, 0, 0, 0, 0, 0, 0}"
    />
    <variable description = "Массив для хранения правых границ сортируемых
                             массивов (необходим для рекурсии)"
        name = "r"
        type = "int[]"
        value = "new int[]{0, 0, 0, 0, 0, 0, 0}"
    />
    <variable 
        description = "Переменная для хранения глубины рекурсии"
        name = "h"
        type = "int"
        value = "0"
    />
    <variable description = "Экземпляр апплета"
        name = "visualizer"
        type = "MergeSortVisualizer"
        value = "null"
    />
    <data>
        <toString>
            StringBuffer s = new StringBuffer();
            return s.toString();
        </toString>
    </data>
    <auto
        id = "Main"
        description = "Главный автомат"
    >
        <start
            comment-ru = "На экране изображён сортируемый массив."
            comment-en = "There is array for sorting on the display."
        >
            <draw>
                @visualizer.hideStack();
                @visualizer.updateBrackets(-1, 0);
                @visualizer.updateMainArray(0, 0, @a.length - 1, 0, 0, 0, 0);
                @visualizer.hideAuxArrays(true);
                @visualizer.stopEditMode();
            </draw>
        </start>
        <step
            id = "StepPreparingToCallMergeSortAuto"
            description = "Подготовка к запуску автомата сортировки массива"
            level = "-1"
        >
            <draw>
                @visualizer.hideStack();
                @visualizer.updateMainArray(0, 0, @a.length - 1, 0, 0, 0, 0);
                @visualizer.hideAuxArrays(true);
                @visualizer.stopEditMode();
            </draw>
            <action>
                @h @= -1;
                @l[0] @= 0;
                @r[0] @= @a.length - 1;
            </action>
        </step>
        <call-auto
            id = "MSort"
            level = "1"
        />
        <finish
            comment-ru = "Сортировка массива завершена."
            comment-en = "Array sorting has been completed."
        >
            <draw>
                @visualizer.hideStack();
                @visualizer.updateBrackets(-1, 1);
                @visualizer.updateMainArray(0, 0, @a.length - 1, 9, 9, 9, 0);
                @visualizer.hideAuxArrays(true);
                @visualizer.stopEditMode();
            </draw>
        </finish>
    </auto>

    <auto
        id = "MSort"
        description = "Автомат, сортирующий часть массива"
    >
        <step
            id = "StepPreparingForSortingArrayPart"
            description = "Подготовка к сортировке указанной части массива"
            comment-ru = "Необходимо отсортировать массив [{0}...{1}]."
            comment-en = "It is necessary to sort array [{0}...{1}]."
            comment-args = "new Integer(@l[@h] + 1),
                            new Integer(@r[@h] + 1)"
            level = "0"
        >
            <draw>
                @visualizer.showStack(@h, 0, true);
                @visualizer.updateMainArray(@l[@h], @l[@h], @r[@h],
                                             3, 3, 3, 0);
                @visualizer.hideAuxArrays(true);
                @visualizer.stopEditMode();
            </draw>
            <action>
                @h @= @h + 1;
            </action>
        </step>
        <if
            id = "IfVerifySortingArrayLength"
            description = "Проверяет длину сортируемой части массива"
            test = "@l[@h] == @r[@h]"
            level = "-1"
        >
            <then>
                <step
                    id = "StepOneElementInArrayPart"
                    description = "Массив состоит из одного элемента"
                    comment-ru = "Массив, состоящий из одного элемента ({0}),
                                  сортировать не надо. Массив [{1}...{1}]
                                  отсортирован."
                    comment-en = "Array consists of one element ({0}).
                                  Array [{1}...{1}] is sorted."
                    comment-args = "new Integer(@a[@l[@h + 1]]),
                                    new Integer(@l[@h + 1] + 1)"
                    level = "0"
                >
                    <draw>
                        @visualizer.showStack(@h + 1, 2, true);
                        @visualizer.updateMainArray(@l[@h + 1], @l[@h + 1],
                                                     @l[@h + 1], 4, 4, 4, 0);
                        @visualizer.hideAuxArrays(true);
                        @visualizer.stopEditMode();
                    </draw>
                    <action>
                        @h @= @h - 1;
                    </action>
                </step>
            </then>
            <else>
                <step
                    id = "StepManyElementsLeftSide"
                    description = "Массив состоит из нескольких элементов.
                                   Сортировка левой половины"
                    comment-ru = "Для того, чтобы отсортировать массив
                                  [{0}...{3}], надо отсортировать его левую
                                  ([{0}...{1}]) и правую ([{2}...{3}]) части.
                                  Сначала можно отсортировать его левую часть
                                  ([{0}...{1}])."
                    comment-en = "It is necessary to sort left ([{0}...{1}]) and
                                  right ([{2}...{3}]) parts of array [{0}...{3}]
                                  to sort last one. The left part ([{0}...{1}])
                                  may be sorted before the rigth one."
                    comment-args = "new Integer(@l[@h] + 1),
                                    new Integer(@r[@h + 1] + 1),
                                    new Integer(@r[@h + 1] + 2),
                                    new Integer(@r[@h] + 1)"
                    level = "0"
                >
                    <draw>
                        @visualizer.showStack(@h, 0, true);
                        @visualizer.updateMainArray(@l[@h], @r[@h + 1],
                                                     @r[@h], 1, 1, 2, 0);
                        @visualizer.hideAuxArrays(true);
                        @visualizer.stopEditMode();
                    </draw>
                    <action>
                        @l[@h + 1] @= @l[@h];
                        @r[@h + 1] @= (@l[@h] + @r[@h]) / 2;
                    </action>
                </step>
                <call-auto
                    id = "MSort"
                    level = "1"
                />
                <step
                    id = "StepManyElementsRightSide"
                    description = "Массив состоит из нескольких элементов.
                                   Сортировка правой половины"
                    comment-ru = "Левая часть массива [{0}...{2}]
                                  отсортирована. Теперь надо отсортировать его
                                  правую часть ([{1}...{2}])."
                    comment-en = "The left part of array [{0}...{2}] is
                                  sorted. The right part ([{1}...{2}])
                                  must be sorted now."
                    comment-args = "new Integer(@l[@h] + 1),
                                    new Integer(@l[@h + 1] + 1),
                                    new Integer(@r[@h] + 1)"
                    level = "0"
                >
                    <draw>
                        @visualizer.showStack(@h, 1, true);
                        @visualizer.updateMainArray(@l[@h], @l[@h + 1] - 1,
                                                     @r[@h], 1, 1, 2, 0);
                        @visualizer.hideAuxArrays(true);
                        @visualizer.stopEditMode();
                    </draw>
                    <action>
                        @l[@h + 1] @= (@l[@h] + @r[@h]) / 2 + 1;
                        @r[@h + 1] @= @r[@h];
                    </action>
                </step>
                <call-auto
                    id = "MSort"
                    level = "1"
                />
                <call-auto
                    id = "Merge"
                    level = "1"
                />
                <step
                    id = "StepAfterMerging"
                    description = "Слияние завершено. Массив отсортирован."
                    comment-ru = "Массив [{0}...{1}] отсортирован."
                    comment-en = "Array [{0}...{1}] is sorted."
                    comment-args = "new Integer(@l[@h + 1] + 1),
                                    new Integer(@r[@h + 1] + 1)"
                    level = "1"
                >
                    <draw>
                        @visualizer.showStack(@h + 1, 2, true);
                        @visualizer.updateMainArray(@l[@h + 1], @l[@h + 1],
                                                     @r[@h + 1], 4, 4, 4, 0);
                        @visualizer.hideAuxArrays(true);
                        @visualizer.stopEditMode();
                    </draw>
                    <action>
                        @h @= @h - 1;
                    </action>
                </step>
            </else>
        </if>
    </auto>

    <auto
        id = "Merge"
        description = "Автомат, реализующий слияние массивов"
    >
        <variable 
            description = "Вспомогательный массив"
            name = "b"
            type = "int[]"
        />
        <variable description = "Указатель на текущий элемент 
                                 левой половины массива"
            name = "i"
            type = "int"
        />
        <variable description = "Указатель на текущий элемент 
                                 правой половины массива"
            name = "j"
            type = "int"
        />
        <variable description = "Счётчик цикла по всему массиву"
            name = "k"
            type = "int"
        />
        <step
            id = "StepPreparingForCopying"
            description = "Подготовка к копорованию элементов"
            level = "-1"
        >
            <draw>
            </draw>
            <action>
                @k @= @l[@h];
                @b @= (int[]) (@a.clone());
            </action>
        </step>
        <while
            id = "LoopCopying"
            description = "Цикл копирования элементов"
            test = "@k &lt;= @r[@h]"
            level = "-1"
        >
            <step
                id = "StepCopying"
                description = "Копирование элемента"
                level = "-1"
            >
                <draw>
                </draw>
                <action>
                    @b[@k] @= @a[@k];
                    @k @= @k + 1;
                </action>
            </step>
        </while>
        <step
            id = "StepPreparingForMerging"
            description = "Подготовка к слиянию массивов"
            comment-ru = "Массивы [{0}...{1}] и [{2}...{3}] отсортированы.
                          Надо произвести их слияние."
            comment-en = "Arrays [{0}...{1}] and [{2}...{3}] have been sorted.
                          They may be merged now."
            comment-args = "new Integer(@l[@h] + 1),
                            new Integer(@l[@h + 1]),
                            new Integer(@l[@h + 1] + 1),
                            new Integer(@r[@h] + 1)"
            level = "1"
        >
            <draw>
                @visualizer.showStack(@h, 2, true);
                @visualizer.updateMainArray(@l[@h], @l[@h + 1] - 1,
                                             @r[@h], 1, 1, 2, 0);
                @visualizer.showAuxArrays(@l[@h], @l[@h + 1] - 1,
                                           @r[@h]);
                @visualizer.updateAuxArrays(@l[@h] - 1, @l[@h + 1] - 1, 1,
                                             0, 2, 2);
                @visualizer.stopEditMode();
            </draw>
            <action>
                @i @= @l[@h];
                @j @= @l[@h + 1];
                @k @= @l[@h];
            </action>
        </step>

        <while
            id = "LoopMerging"
            description = "Цикл слияния массивов"
            test = "@k &lt;= @r[@h]"
            level = "-1"
        >
            <if
                id = "StepVerifyArrayLengths"
                description = "Проверка длин массивов"
                test = "(@i &gt;= @l[@h + 1]) || (@j &gt; @r[@h])"
                level = "-1"
            >
                <then>
                    <if
                        id = "IfVerifyFirstArrayLength"
                        description = "Проверка длины первого массива"
                        test = "@i &gt;= @l[@h + 1]"
                        level = "-1"
                    >
                        <then>
                            <step
                                id = "StepFirstArrayIsEmpty"
                                description = "Первый массив закончился"
                                comment-ru = "В первом массиве не осталось
                                              элементов. Берётся элемент второго
                                              массива ({0})."
                                comment-en = "All elements of first array have
                                              been checked. The element of
                                              second array ({0}) is taken."
                                comment-args = "new Integer(@b[@j - 1])"
                                level = "1"
                            >
                                <draw>
                                    @visualizer.updateMainArray(@l[@h],
                                                                 @k - 1,
                                                                 @r[@h],
                                                                 5, 6, 8, 7);
                                    @visualizer.showAuxArrays(@l[@h],
                                                               @l[@h + 1] - 1,
                                                               @r[@h]);
                                    @visualizer.updateAuxArrays(@i, @j - 1,
                                                                 1, 0, 2, 3);
                                    @visualizer.stopEditMode();
                                </draw>
                                <action>
                                    @a[@k] @= @b[@j];
                                    @j @= @j + 1;
                                    @k @= @k + 1;
                                </action>
                            </step>
                        </then>
                        <else>
                            <step
                                id = "StepSecondArrayIsEmpty"
                                description = "Второй массив закончился"
                                comment-ru = "Во втором массиве не осталось
                                              элементов. Берётся элемент первого
                                              массива ({0})."
                                comment-en = "All elements of second array have
                                              been checked. The element of first
                                              array ({0}) is taken."
                                comment-args = "new Integer(@b[@i - 1])"
                                level = "1"
                            >
                                <draw>
                                    @visualizer.updateMainArray(@l[@h],
                                                                 @k - 1,
                                                                 @r[@h],
                                                                 5, 6, 8, 7);
                                    @visualizer.showAuxArrays(@l[@h],
                                                               @l[@h + 1] - 1,
                                                               @r[@h]);
                                    @visualizer.updateAuxArrays(@i - 1, @j,
                                                                 1, 0, 3, 2);
                                    @visualizer.stopEditMode();
                                </draw>
                                <action>
                                    @a[@k] @= @b[@i];
                                    @i @= @i + 1;
                                    @k @= @k + 1;
                                </action>
                            </step>
                        </else>
                    </if>
                </then>
                <else>
                    <step
                        id = "StepBeforeCompareElements"
                        description = "Надо сравненить элементы массивов"
                        comment-ru = "Надо найти меньший из текущих элементов
                                      первого ({0}) и второго ({1}) массивов."
                        comment-en = "It is necessary to find minimal of current
                                      elements of first ({0}) and second ({1})
                                      arrays."
                        comment-args = "new Integer(@b[@i]),
                                        new Integer(@b[@j])"
                        level = "1"
                    >
                        <draw>
                            @visualizer.updateMainArray(@l[@h], @k - 1,
                                                         @r[@h], 5, 5, 8, 7);
                            @visualizer.showAuxArrays(@l[@h],
                                                       @l[@h + 1] - 1,
                                                       @r[@h]);
                            @visualizer.updateAuxArrays(@i, @j,
                                                         1, 0, 2, 2);
                            @visualizer.stopEditMode();
                        </draw>
                        <action>
                        </action>
                    </step>
                    <if
                        id = "IfCompareElements"
                        description = "Сравнение элементов массивов"
                        test = "@b[@i] &gt; @b[@j]"
                        level = "-1"
                    >
                        <then>
                            <step
                                id = "StepSecondElementIsLower"
                                description = "Элемент второго массива меньше
                                               элемента первого массива"
                                comment-ru = "Элемент первого массива ({0})
                                              больше элемента второго массива
                                              ({1}). Берётся элемент второго
                                              массива ({1})."
                                comment-en = "The element of first array ({0})
                                              is greater than the element of
                                              second array ({1}). The element
                                              of second array ({1}) is taken."
                                comment-args = "new Integer(@b[@i]),
                                                new Integer(@b[@j - 1])"
                                level = "1"
                            >
                                <draw>
                                    @visualizer.updateMainArray(@l[@h],
                                                                 @k - 1,
                                                                 @r[@h],
                                                                 5, 6, 8, 7);
                                    @visualizer.showAuxArrays(@l[@h],
                                                               @l[@h + 1] - 1,
                                                               @r[@h]);
                                    @visualizer.updateAuxArrays(@i, @j - 1,
                                                                 1, 0, 2, 3);
                                    @visualizer.stopEditMode();
                                </draw>
                                <action>
                                    @a[@k] @= @b[@j];
                                    @j @= @j + 1;
                                    @k @= @k + 1;
                                </action>
                            </step>
                        </then>
                        <else>
                            <step
                                id = "StepFirstElementNotGreater"
                                description = "Элемент первого массива не
                                               превосходит элемента второго
                                               массива"
                                comment-ru = "Элемент первого массива ({0})
                                              не больше элемента второго массива
                                              ({1}). Берётся элемент первого
                                              массива ({0})."
                                comment-en = "The element of first array ({0})
                                              is not greater than the element of
                                              second array ({1}). The element of
                                              first array ({0}) is taken."
                                comment-args = "new Integer(@b[@i - 1]),
                                                new Integer(@b[@j])"
                                level = "1"
                            >
                                <draw>
                                    @visualizer.updateMainArray(@l[@h],
                                                                 @k - 1,
                                                                 @r[@h],
                                                                 5, 6, 8, 7);
                                    @visualizer.showAuxArrays(@l[@h],
                                                               @l[@h + 1] - 1,
                                                               @r[@h]);
                                    @visualizer.updateAuxArrays(@i - 1, @j,
                                                                 1, 0, 3, 2);
                                    @visualizer.stopEditMode();
                                </draw>
                                <action>
                                    @a[@k] @= @b[@i];
                                    @i @= @i + 1;
                                    @k @= @k + 1;
                                </action>
                            </step>
                        </else>
                    </if>
                </else>
            </if>
        </while>
    </auto>
</algorithm>
