<?xml version="1.0" encoding="WINDOWS-1251"?>

<algorithm>
    <variable 
        description = "Экземпляр апплета"
        name        = "visualizer"
        type        = "BTreeVisualizer"
        value       = "null"
    />

    <variable
        description = "Признаки листов"
        name        = "leaf"
        type        = "boolean[]"
        value       = "new boolean[26]"
    />
    <variable
        description = "Кол-во ключей"
        name        = "n"
        type        = "int[]"
        value       = "new int[26]"
    />
    <variable
        description = "Ключи"
        name        = "key"
        type        = "char[][]"
        value       = "new char[26][26]"
    />
    <variable
        description = "Ссылки"
        name        = "c"
        type        = "int[][]"
        value       = "new int[26][26]"
    />
    <variable
        description = "Кол-во узлов"
        name        = "num"
        type        = "int"
        value       = "1"
    />
    <variable
        description = "Текущий узел"
        name        = "x"
        type        = "int"
        value       = "1"
    />
    <variable
        description = "Ключ"
        name        = "k"
        type        = "char"
        value       = "'A'"
    />

    <variable
        description = "Корень дерева"
        name        = "root"
        type        = "int"
        value       = "1"
    />

    <variable
        description = "???"
        name        = "t"
        type        = "int"
        value       = "2"
    />
    
    <variable
        description = "???"
        name        = "y"
        type        = "int"
        value       = "0"
    />

    <variable
        description = "???"
        name        = "m"
        type        = "int"
        value       = "0"
    />

    <variable 
        description = "Русская Строка"
        name        = "sRu"
        type        = "String"
        value       = "new String()"
    />

    <variable 
        description = "English String"
        name        = "sEn"
        type        = "String"
        value       = "new String()"
    />
    
    <data>
        <toString>
            return("");
        </toString>
    </data>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="SplitChild" description="Разрезает вершину">
        <variable
            description = ""
            name        = "z"
            type        = "int"
        />
        <variable 
            description = "Переменная цикла"
            name        = "j"
            type        = "int"
        />

        <step
            id="Loop1Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @num @= @num + 1;
                @z @= @num;

                @leaf[@z] @= @leaf[@y];
                @n[@z] @= @t - 1;

                @j @= 1;
            </action>
        </step>
        <while
            id="Loop1"
            description="Цикл"
            test="@j &lt;= @t - 1"
            level="-1"
        >
            <step
                id="StepInLoop1"
                description="XZ"
                level="-1"
            >
                <action>
                    @key[@z][@j] @= @key[@y][@j + @t];

                    @j @= @j + 1;
                </action>
            </step>
        </while>
        <if
            id="If1"
            description="XZ"
            test="!@leaf[@y]"
            level="-1"
        >
            <then>
                <step
                    id="Loop2Init"
                    description="Начало цикла"
                    level="-1"
                >
                    <action>
                        @j @= 1;
                    </action>
                </step>
                <while
                    id="Loop2"
                    description="Цикл"
                    test="@j &lt;= @t"
                    level="-1"
                >
                    <step
                        id="StepInLoop2"
                        description="XZ"
                        level="-1"
                    >
                        <action>
                            @c[@z][@j] = @c[@y][@j + @t];
                            @j @= @j + 1;
                        </action>
                    </step>
                </while>
            </then>
        </if>
        <step
            id="Loop3Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @n[@y] @= @t - 1;
                @j @= @n[@x] + 1;
            </action>
        </step>
        <while
            id="Loop3"
            description="Цикл"
            test="@m &lt;= @j"
            level="-1"
        >
            <step
                id="StepInLoop3"
                description="XZ"
                level="-1"
            >
                <action>
                    @c[@x][@j + 1] @= @c[@x][@j];
                    @j @= @j - 1;
                </action>
            </step>
        </while>
        <step
            id="Loop4Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @c[@x][@m + 1] @= @z;
                @j @= @n[@x];
            </action>
        </step>
        <while
            id="Loop4"
            description="Цикл"
            test="@m &lt;= @j"
            level="-1"
        >
            <step
                id="StepInLoop4"
                description="XZ"
                level="-1"
            >
                <action>
                    @key[@x][@j + 1] @= @key[@x][@j];
                    @j @= @j - 1;
                </action>
            </step>
        </while>
        <step
            id="FinalStep"
            description="XZ"
            level="-1"
        >
            <action>
                @key[@x][@m] @= @key[@y][@t];
                @n[@x] @= @n[@x] + 1;
            </action>
        </step>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id = "InsertNonfull" description = "">
        <variable 
            description = "Переменная цикла"
            name        = "flag"
            type        = "boolean"
        />

        <variable 
            description = "Переменная цикла"
            name        = "i"
            type        = "int"
        />

        <step id="GoGoGo" description="XZ" level="-1"><action>
            @flag @= true;
        </action></step>

        <while
            id = "GO"
            test = "@flag"
            level = "-1"
            description = "XZ"
        >

        <step
            id="Loop1Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @i @= @n[@x];
            </action>
        </step>

        <if
            id               = "If"
            description      = "Если текущая вершина лист"
            test             = "@leaf[@x]"
            level="-1"
        >
            <then>
                <step
                    id="DrawStep1"
                    description="InThis"
                    comment-ru="В этом листе должен размещаться ключ."
                >
                    <draw>
                        @visualizer.showTree(@x, 2);
                    </draw>
                    <action>
                    </action>
                </step>
                <while
                    id          = "Loop1"
                    description = "Цикл"
                    test        = "(1 &lt;= @i) &amp;&amp; (@k &lt; @key[@x][@i])"
                    level       = "-1"
                >
                    <step id="StepInLoop1" description="XZ1" level="-1"><action>
                        @key[@x][@i + 1] @= @key[@x][@i];
                        @i @= @i - 1;
                    </action></step>
                </while>
                <step
                    id="StepAfterLoop1"
                    description = "XZ2"
                    comment-ru  = "Помещаем его в конец листа, а затем сдвигаем влево, пока он не встанет на нужное место."
                    comment-en  = "XZ"
                >
                    <draw>
                        @visualizer.showTree(-1, 0);
                    </draw>
                    <action>
                        @key[@x][@i + 1] @= @k;
                        @n[@x] @= @n[@x] + 1;
                        @flag @= false;
                    </action>
                </step>
            </then>
            <else>
                <step
                    id="DrawStep2"
                    description="XZ"
                    comment-ru="Просматриваем вершину с конца в начало, сравнивая её ключи с ключом, который нам необходимо вставить. Таким образом мы найдем ребенка текущей вершины, в котором необходимо продолжить работу."
                >
                    <draw>
                        @visualizer.showTree(@x, 2);
                    </draw>
                    <action>
                    </action>
                </step>
                <while
                    id          = "Loop2"
                    description = "Цикл"
                    test        = "(1 &lt;= @i) &amp;&amp; (@k &lt; @key[@x][@i])"
                    level       = "-1"
                >
                    <step id="StepInLoop2" description="XZ1" level="-1"><action>
                        @i @= @i - 1;
                    </action></step>
                </while>
                <step id="StepAfterLoop2" description="XZ2" level="-1"><action>
                    @i @= @i + 1;
                </action></step>
                <if
                    id = "If2"
                    description = "XZ"
                    test = "@n[@c[@x][@i]] == 2 * @t - 1"
                    level = "-1"
                >
                    <then>
                        <step id="Init" description="XZ" level = "-1"><action>
                            @m @= @i;
                            @y @= @c[@x][@i];
                        </action></step>
                        <call-auto id="SplitChild"/>
                        <step
                            id="test"
                            description="XZ"
                            comment-ru="Поскольку вершина была заполнена до предела, мы разделили её на две части. При этом её медиана отошла к родителю."
                        >
                            <draw>
                                @visualizer.showTree(-1, 0);
                            </draw>
                            <action>
                            </action>
                        </step>
                        <if
                            id = "If3"
                            description = "XZ"
                            test = "@key[@x][@i] &lt; @k"
                            level = "-1"
                        ><then>
                            <step id="StepInIf" description="XZ" level="-1"><action>
                                @i @= @i + 1;
                            </action></step>
                        </then></if>
                    </then>
                </if>
                <step
                    id          = "FinalStep"
                    description = "XZ"
                    comment-ru  = "Переходим к следующей вершине. Теперь она является корнем поддерева, в которое необходимо вставить требуемый ключ."
                    comment-en  = "XZ"
                >
                    <draw>
                        @visualizer.showTree(@x, 1);
                    </draw>
                    <action>
                        @x @= @c[@x][@i];
                    </action>
                </step>
            </else>
        </if>
        </while>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="Insert" description="Добавляет ключ в дерево">
        <step
            id = "InsertEnter"
            description="XZ"
            level = "-1"
        >
            <draw>
                @visualizer.showTree(-1, 0);
            </draw>
            <action>
                @sRu @= new String("Готово! Ключ вставлен на нужное место.");
                @sEn @= new String("Completed!");

                @x @= @root;
                @y @= @root;
            </action>
        </step>

        <if
            id = "If1"
            description = "Если корень полный"
            test = "@n[@y] == 2 * @t - 1"
            level = "-1"
        >
            <then>
                <step id="Step" description="XZ" level="-1"><action>
                    @num @= @num + 1;
                    @x @= @num;

                    @root @= @x;
                    @leaf[@x] @= false;
                    @n[@x] @= 0;
                    @c[@x][1] @= @y;
                    @m @= 1;
                </action></step>
                <call-auto id="SplitChild"/>
                <step
                    id="test"
                    description="XZ"
                    comment-ru="Корень был заполнен до предела. Поэтому мы разделили его на две части, тем самым повышая высоту дерева на один уровень. Единственным ключом нового корня является теперь медиана старого."
                >
                    <draw>
                        @visualizer.showTree(-1, 0);
                    </draw>
                    <action>
                        @x @= @root;
                    </action>
                </step>
                <call-auto id="InsertNonfull"/>
            </then>
            <else>
                <call-auto id="InsertNonfull"/>
            </else>
        </if>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="Delete" description="Удаляет ключ из дерева">
        <step
            id="LoopInit"
            description="Начало цикла"
            level="-1"
        >
            <action>
            </action>
        </step>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="Main" description="Главный автомат">
        <start
            comment-ru="На экране изображено Б-Дерево. Выберите операцию и ключ для произведения операции."
            comment-en="There is an B-Tree on the display"
        >
            <draw>
                @visualizer.showTree(-1, 0);
            </draw>
        </start>


            <if
                id="InsertChoice"
                description="Выбрано добавление"
                test="@visualizer.combobox1.getSelectedIndex() == 0"
                level="-1"
            >
                <then>
                    <step
                        id="test"
                        description="this is test"
                        comment-ru="Добавление"
                    >
                        <draw>
                            @visualizer.showTree(-1, 0);
                        </draw>
                        <action>
                            @k = @visualizer.get();
                        </action>
                    </step>
                    <call-auto id="Insert"/>
                </then>
            </if>

            <if
                id="DeleteChoice"
                description="Выбрано удаление"
                test="@visualizer.combobox1.getSelectedIndex() == 1"
                level="-1"
            >
                <then>
                    <call-auto id="Delete"/>
                </then>
            </if>

            <finish
                comment-ru="{0}"
                comment-en="{1}"
                comment-args="new String(@sRu), new String(@sEn)"
            >
                <draw>
                    @visualizer.showTree(-1, 0);
                </draw>
            </finish>
    </auto>

</algorithm>
