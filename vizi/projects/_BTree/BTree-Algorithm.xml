<?xml version="1.0" encoding="WINDOWS-1251"?>

<algorithm>
    <variable 
        description = "Экземпляр апплета"
        name        = "visualizer"
        type        = "BTreeVisualizer"
        value       = "null"
    />

    <variable
        description = "Корень дерева"
        name        = "root"
        type        = "treeNode"
        value       = "null"
    />

    <variable
        description = "Текущий узел"
        name        = "x"
        type        = "treeNode"
        value       = "null"
    />

    <variable
        description = "Ключ"
        name        = "k"
        type        = "char"
        value       = "'A'"
    />

    <variable
        description = "???"
        name        = "t"
        type        = "int"
        value       = "2"
    />
    
    <variable
        description = "???"
        name        = "y"
        type        = "treeNode"
        value       = "null"
    />

    <variable
        description = "???"
        name        = "m"
        type        = "int"
        value       = "0"
    />

    <variable 
        description = "Русская Строка"
        name        = "sRu"
        type        = "String"
        value       = "new String()"
    />

    <variable 
        description = "English String"
        name        = "sEn"
        type        = "String"
        value       = "new String()"
    />
    
    <data>
        <toString>
            return("");
        </toString>
    </data>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="SplitChild" description="Разрезает вершину">
        <variable
            description = ""
            name        = "z"
            type        = "treeNode"
        />
        <variable 
            description = "Переменная цикла"
            name        = "j"
            type        = "int"
        />

        <step
            id="Loop1Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @z @= new treeNode();
                @z.leaf @= @y.leaf;
                @z.n @= @t - 1;
                @j @= 1;
            </action>
        </step>
        <while
            id="Loop1"
            description="Цикл"
            test="@j &lt;= @t - 1"
            level="-1"
        >
            <step
                id="StepInLoop1"
                description="XZ"
                level="-1"
            >
                <action>
                    @z.keys[@j] @= @y.keys[@j + @t];
                    @j @= @j + 1;
                </action>
            </step>
        </while>
        <if
            id="If1"
            description="XZ"
            test="!@y.leaf"
            level="-1"
        >
            <then>
                <step
                    id="Loop2Init"
                    description="Начало цикла"
                    level="-1"
                >
                    <action>
                        @j @= 1;
                    </action>
                </step>
                <while
                    id="Loop2"
                    description="Цикл"
                    test="@j &lt;= @t"
                    level="-1"
                >
                    <step
                        id="StepInLoop2"
                        description="XZ"
                        level="-1"
                    >
                        <action>
                            @z.links[@j] @= @y.links[@j + @t];
                            @j @= @j + 1;
                        </action>
                    </step>
                </while>
            </then>
        </if>
        <step
            id="Loop3Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @y.n @= @t - 1;
                @j @= @x.n + 1;
            </action>
        </step>
        <while
            id="Loop3"
            description="Цикл"
            test="@m &lt;= @j"
            level="-1"
        >
            <step
                id="StepInLoop3"
                description="XZ"
                level="-1"
            >
                <action>
                    @x.links[@j + 1] @= @x.links[@j];
                    @j @= @j - 1;
                </action>
            </step>
        </while>
        <step
            id="Loop4Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @x.links[@m + 1] @= @z;
                @j @= @x.n;
            </action>
        </step>
        <while
            id="Loop4"
            description="Цикл"
            test="@m &lt;= @j"
            level="-1"
        >
            <step
                id="StepInLoop4"
                description="XZ"
                level="-1"
            >
                <action>
                    @x.keys[@j + 1] @= @x.keys[@j];
                    @j @= @j - 1;
                </action>
            </step>
        </while>
        <step
            id="FinalStep"
            description="XZ"
            level="-1"
        >
            <action>
                @x.keys[@m] @= @y.keys[@t];
                @x.n @= @x.n + 1;
            </action>
        </step>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id = "InsertNonfull" description = "">
        <variable 
            description = "Переменная цикла"
            name        = "flag"
            type        = "boolean"
        />

        <variable 
            description = "Переменная цикла"
            name        = "i"
            type        = "int"
        />

        <step id="GoGoGo" description="XZ" level="-1"><action>
            @flag @= true;
        </action></step>

        <while
            id = "GO"
            test = "@flag"
            level = "-1"
            description = "XZ"
        >

        <step
            id="Loop1Init"
            description="Начало цикла"
            level="-1"
        >
            <action>
                @i @= @x.n;
            </action>
        </step>

        <if
            id               = "If"
            description      = "Если текущая вершина лист"
            test             = "@x.leaf"
            level="-1"
        >
            <then>
                <step
                    id="DrawStep1"
                    description="InThis"
                    comment-ru="В этом листе должен размещаться ключ."
                >
                    <draw>
                        @visualizer.showTree(@x);
                    </draw>
                    <action>
                    </action>
                </step>
                <while
                    id          = "Loop1"
                    description = "Цикл"
                    test        = "(1 &lt;= @i) &amp;&amp; (@k &lt; @x.keys[@i])"
                    level       = "-1"
                >
                    <step id="StepInLoop1" description="XZ1" level="-1"><action>
                        @x.keys[@i + 1] @= @x.keys[@i];
                        @i @= @i - 1;
                    </action></step>
                </while>
                <step
                    id="StepAfterLoop1"
                    description = "XZ2"
                    comment-ru  = "Помещаем его в конец листа, а затем сдвигаем влево, пока он не встанет на нужное место."
                    comment-en  = "XZ"
                >
                    <draw>
                        @visualizer.showTree(null);
                    </draw>
                    <action>
                        @x.keys[@i + 1] @= @k;
                        @x.n @= @x.n + 1;
                        @flag @= false;
                    </action>
                </step>
            </then>
            <else>
                <step
                    id="DrawStep2"
                    description="XZ"
                    comment-ru="Просматриваем вершину с конца в начало, сравнивая её ключи с ключом, который нам необходимо вставить. Таким образом мы найдем ребенка текущей вершины, в котором необходимо продолжить работу."
                >
                    <draw>
                        @visualizer.showTree(@x);
                    </draw>
                    <action>
                    </action>
                </step>
                <while
                    id          = "Loop2"
                    description = "Цикл"
                    test        = "(1 &lt;= @i) &amp;&amp; (@k &lt; @x.keys[@i])"
                    level       = "-1"
                >
                    <step id="StepInLoop2" description="XZ1" level="-1"><action>
                        @i @= @i - 1;
                    </action></step>
                </while>
                <step id="StepAfterLoop2" description="XZ2" level="-1"><action>
                    @i @= @i + 1;
                </action></step>
                <if
                    id = "If2"
                    description = "XZ"
                    test = "@x.links[@i].n == 2 * @t - 1"
                    level = "-1"
                >
                    <then>
                        <step id="Init" description="XZ" level = "-1"><action>
                            @m @= @i;
                            @y @= @x.links[@i];
                        </action></step>
                        <call-auto id="SplitChild"/>
                        <step
                            id="test"
                            description="XZ"
                            comment-ru="Поскольку вершина была заполнена до предела, мы разделили её на две части. При этом её медиана отошла к родителю."
                        >
                            <draw>
                                @visualizer.showTree(null);
                            </draw>
                            <action>
                            </action>
                        </step>
                        <if
                            id = "If3"
                            description = "XZ"
                            test = "@x.keys[@i] &lt; @k"
                            level = "-1"
                        ><then>
                            <step id="StepInIf" description="XZ" level="-1"><action>
                                @i @= @i + 1;
                            </action></step>
                        </then></if>
                    </then>
                </if>
                <step
                    id          = "FinalStep"
                    description = "XZ"
                    comment-ru  = "Переходим к следующей вершине. Теперь она является корнем поддерева, в которое необходимо вставить требуемый ключ."
                    comment-en  = "XZ"
                >
                    <draw>
                        @visualizer.showTree(null);
                    </draw>
                    <action>
                        @x @= @x.links[@i];
                    </action>
                </step>
            </else>
        </if>
        </while>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="Insert" description="Добавляет ключ в дерево">
        <step
            id = "InsertEnter"
            description="XZ"
            level = "-1"
        >
            <draw>
                @visualizer.showTree(null);
            </draw>
            <action>
                @sRu @= new String("Готово! Ключ вставлен на нужное место.");
                @sEn @= new String("Completed!");

                @x @= @root;
                @y @= @root;
            </action>
        </step>

        <if
            id = "If1"
            description = "Если корень полный"
            test = "@y.n == 2 * @t - 1"
            level = "-1"
        >
            <then>
                <step id="Step" description="XZ" level="-1"><action>
                    @x @= new treeNode();
                    @root @= @x;
                    @x.leaf @= false;
                    @x.n @= 0;
                    @x.links[1] @= @y;
                    @m @= 1;
                </action></step>
                <call-auto id="SplitChild"/>
                <step
                    id="test"
                    description="XZ"
                    comment-ru="Корень был заполнен до предела. Поэтому мы разделили его на две части, тем самым повышая высоту дерева на один уровень. Единственным ключом нового корня является теперь медиана старого."
                >
                    <draw>
                        @visualizer.showTree(null);
                    </draw>
                    <action>
                        @x @= @root;
                    </action>
                </step>
                <call-auto id="InsertNonfull"/>
            </then>
            <else>
                <call-auto id="InsertNonfull"/>
            </else>
        </if>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="Delete" description="Удаляет ключ из дерева">
        <step
            id="LoopInit"
            description="Начало цикла"
            level="-1"
        >
            <action>
            </action>
        </step>
    </auto>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <auto id="Main" description="Главный автомат">
        <start
            comment-ru="На экране изображено Б-Дерево. Выберите операцию и ключ для произведения операции."
            comment-en="There is an B-Tree on the display"
        >
            <draw>
                @visualizer.showTree(null);
            </draw>
        </start>


        <if
            id="InsertChoice"
            description="Выбрано добавление"
            test="@visualizer.combobox1.getSelectedIndex() == 0"
            level="-1"
        >
            <then>
                <call-auto id="Insert"/>
            </then>
        </if>

        <if
            id="DeleteChoice"
            description="Выбрано удаление"
            test="@visualizer.combobox1.getSelectedIndex() == 1"
            level="-1"
        >
            <then>
                <call-auto id="Delete"/>
            </then>
        </if>

        <finish
            comment-ru="{0}"
            comment-en="{1}"
            comment-args="new String(@sRu), new String(@sEn)"
        >
            <draw>
                @visualizer.showTree(null);
            </draw>
        </finish>
    </auto>

</algorithm>
